@namespace LionFire.OpenCode.Blazor.Components.Tools
@using LionFire.OpenCode.Blazor.Components.Shared

<div class="tool-call @GetStateClass()">
    <Collapsible @bind-IsExpanded="IsExpanded" Class="tool-collapsible">
        <Header>
            <div class="tool-header-content">
                <svg class="tool-icon" viewBox="0 0 24 24">
                    @((MarkupString)GetIconSvg())
                </svg>
                <span class="tool-name">@GetToolSummary()</span>
                <span class="tool-status">@GetStatusText()</span>
                @if (State == ToolState.Running && !HasPendingPermission)
                {
                    <div class="tool-spinner"></div>
                }
            </div>
        </Header>
        <ChildContent>
            <div class="tool-details">
                @if (Input != null)
                {
                    <div class="tool-section">
                        <span class="tool-section-label">Input</span>
                        <pre class="tool-data">@FormatData(Input)</pre>
                    </div>
                }
                @if (Output != null && (State == ToolState.Completed || State == ToolState.Error))
                {
                    <div class="tool-section">
                        <span class="tool-section-label">Output</span>
                        <pre class="tool-data">@FormatData(Output)</pre>
                    </div>
                }
            </div>
        </ChildContent>
    </Collapsible>
</div>

@code {
    private static readonly ToolRegistry _registry = new();

    [Parameter] public string ToolName { get; set; } = "";
    [Parameter] public string? CallId { get; set; }
    [Parameter] public ToolState State { get; set; } = ToolState.Pending;
    [Parameter] public object? Input { get; set; }
    [Parameter] public object? Output { get; set; }
    [Parameter] public bool HasPendingPermission { get; set; }
    [Parameter] public bool IsExpanded { get; set; }
    [Parameter] public EventCallback<bool> IsExpandedChanged { get; set; }

    private string GetStateClass() => State switch
    {
        ToolState.Pending => "tool-pending",
        ToolState.Running => HasPendingPermission ? "tool-permission" : "tool-running",
        ToolState.Completed => "tool-completed",
        ToolState.Error => "tool-error",
        _ => ""
    };

    private string GetStatusText()
    {
        if (HasPendingPermission) return "Awaiting Permission";
        return State switch
        {
            ToolState.Pending => "",
            ToolState.Running => "",
            ToolState.Completed => "",
            ToolState.Error => "Error",
            _ => ""
        };
    }

    private string GetToolSummary()
    {
        return _registry.GetSummary(ToolName, Input);
    }

    private string GetIconSvg()
    {
        var iconName = _registry.GetIcon(ToolName);
        return iconName switch
        {
            "visibility" => "<path fill=\"currentColor\" d=\"M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zM12 17c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5zm0-8c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z\"/>",
            "create" => "<path fill=\"currentColor\" d=\"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z\"/>",
            "edit" => "<path fill=\"currentColor\" d=\"M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z\"/>",
            "terminal" => "<path fill=\"currentColor\" d=\"M20 19V7H4v12h16m0-14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h16M7.5 11l1.5-1.5L6 7l-1.5 1.5L7.5 11M6 13l-1.5 1.5L7.5 17l1.5-1.5L6 13M12 17h8v-2h-8v2z\"/>",
            "search" => "<path fill=\"currentColor\" d=\"M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z\"/>",
            "find_in_page" => "<path fill=\"currentColor\" d=\"M20 19.59V8l-6-6H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c.45 0 .85-.15 1.19-.4l-4.43-4.43c-.8.52-1.74.83-2.76.83-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5c0 1.02-.31 1.96-.83 2.75L20 19.59zM9 13c0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3-3 1.34-3 3z\"/>",
            "public" => "<path fill=\"currentColor\" d=\"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z\"/>",
            "checklist" => "<path fill=\"currentColor\" d=\"M22 7h-9v2h9V7zm0 8h-9v2h9v-2zM5.54 11L2 7.46l1.41-1.41 2.12 2.12 4.24-4.24 1.41 1.41L5.54 11zm0 8L2 15.46l1.41-1.41 2.12 2.12 4.24-4.24 1.41 1.41L5.54 19z\"/>",
            "assignment" => "<path fill=\"currentColor\" d=\"M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z\"/>",
            _ => "<path fill=\"currentColor\" d=\"M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z\"/>"
        };
    }

    private string FormatData(object? data)
    {
        if (data == null) return "";
        if (data is string s) return TruncateString(s, 1000);

        try
        {
            var json = System.Text.Json.JsonSerializer.Serialize(data, new System.Text.Json.JsonSerializerOptions { WriteIndented = true });
            return TruncateString(json, 1000);
        }
        catch
        {
            return TruncateString(data.ToString() ?? "", 1000);
        }
    }

    private string TruncateString(string s, int maxLength)
    {
        if (s.Length <= maxLength) return s;
        return s[..(maxLength - 3)] + "...";
    }
}

<style>
    .tool-call {
        margin: 8px 0;
        border-radius: var(--radius-md);
        background: var(--surface-inset-base);
        overflow: hidden;
    }

    .tool-collapsible {
        background: transparent;
    }

    .tool-header-content {
        display: flex;
        align-items: center;
        gap: 8px;
        flex: 1;
        min-width: 0;
    }

    .tool-icon {
        width: 16px;
        height: 16px;
        flex-shrink: 0;
        color: var(--icon-base);
    }

    .tool-name {
        font-size: var(--font-size-small);
        font-weight: var(--font-weight-medium);
        color: var(--text-base);
        font-family: var(--font-family-mono);
        flex: 1;
        min-width: 0;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .tool-status {
        font-size: var(--font-size-xs);
        color: var(--text-weaker);
        flex-shrink: 0;
    }

    .tool-spinner {
        width: 14px;
        height: 14px;
        border: 2px solid var(--border-interactive-base);
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        flex-shrink: 0;
    }

    @@keyframes spin {
        to { transform: rotate(360deg); }
    }

    .tool-pending .tool-icon { color: var(--icon-weak); }
    .tool-running .tool-icon { color: var(--icon-interactive-base); }
    .tool-completed .tool-icon { color: var(--icon-success-base); }
    .tool-error .tool-icon { color: var(--icon-critical-base); }
    .tool-permission .tool-icon { color: var(--icon-warning-base); }

    .tool-error .tool-status { color: var(--text-error-base); }
    .tool-permission .tool-status { color: var(--icon-warning-base); }

    .tool-details {
        padding-top: 8px;
    }

    .tool-section {
        margin-bottom: 12px;
    }

    .tool-section:last-child {
        margin-bottom: 0;
    }

    .tool-section-label {
        display: block;
        font-size: var(--font-size-xs);
        font-weight: var(--font-weight-medium);
        color: var(--text-weaker);
        margin-bottom: 4px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .tool-data {
        background: var(--surface-inset-strong);
        border-radius: var(--radius-sm);
        padding: 8px;
        margin: 0;
        font-size: var(--font-size-xs);
        font-family: var(--font-family-mono);
        color: var(--text-base);
        white-space: pre-wrap;
        word-break: break-word;
        max-height: 300px;
        overflow-y: auto;
    }
</style>
